include $(TOPDIR)/rules.mk

PKG_NAME:=flashrom
PKG_VERSION:=0.9.8-rc1-r1883
PKG_RELEASE:=1
PKG_MD5SUM:=ede307474fa48460f8a02bc6c3e16b60

PKG_SOURCE_URL:=https://dl.meraki.net/
PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.bz2
PKG_CAT:=bzcat

PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)
PKG_INSTALL_DIR:=$(PKG_BUILD_DIR)/ipkg-install

include $(TOPDIR)/package/rules.mk

$(eval $(call PKG_template,FLASHROM,flashrom,$(PKG_VERSION)-$(PKG_RELEASE),$(ARCH)))

$(PKG_BUILD_DIR)/.configured:
	touch $@

$(PKG_BUILD_DIR)/.built:
	$(MAKE) -C $(PKG_BUILD_DIR) \
		CC="$(TARGET_CC)" STRIP="$(TARGET_CROSS)strip" AR=$(TARGET_AR) RANLIB="$(TARGET_CROSS)ranlib" \
		CFLAGS="$(TARGET_CFLAGS)" CPPFLAGS="-I$(STAGING_DIR)/usr/include" LDFLAGS="-L$(STAGING_DIR)/usr/lib" \
		CONFIG_SERPROG=no CONFIG_RAYER_SPI=no CONFIG_PONY_SPI=no CONFIG_NIC3COM=no CONFIG_GFXNVIDIA=no \
		CONFIG_SATASII=no CONFIG_ATAVIA=no CONFIG_FT2232_SPI=no CONFIG_USBBLASTER_SPI=no CONFIG_PICKIT2_SPI=no \
		CONFIG_DRKAISER=no CONFIG_NICREALTEK=no CONFIG_NICNATSEMI=no CONFIG_OGP_SPI=no CONFIG_BUSPIRATE_SPI=no \
		CONFIG_SATAMV=no CONFIG_IT8212=no CONFIG_PRINT_WIKI=no \
		PREFIX="/usr" DESTDIR=$(PKG_INSTALL_DIR) install
	touch $@

$(IPKG_FLASHROM):
	install -d -m0755 $(IDIR_FLASHROM)/usr/sbin
	$(CP) $(PKG_INSTALL_DIR)/usr/sbin/flashrom $(IDIR_FLASHROM)/usr/sbin/
	$(RSTRIP) $(IDIR_FLASHROM)/
	$(IPKG_BUILD) $(IDIR_FLASHROM) $(PACKAGE_DIR)
